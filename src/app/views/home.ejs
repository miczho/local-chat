<%- include("head"); %>

<style type="text/css">
  @import url(https://fonts.googleapis.com/css?family=Roboto:300);

  #chat-board {
    border: 2px solid #dedede;
    background-color: #f1f1f1;
    border-radius: 5px;
    padding: 10px;
  }
  
  .form-control {
    font-family: "Roboto", sans-serif;
  }

  .chat-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    border-radius: 5px;
    padding: 10px;
    margin: 5px 0px 5px 0px;
  }
  
  .darker {
    background-color: #ddd;
  }

  .chat-content {
    padding-left: 10px;
    padding-right: 10px;
    margin-left: 0px;
    margin-right: 0px;
  }
</style>

<div style="padding-top:10px;" >
    <div class="col"><p class="h3" align="center"><strong>Chatting as <u><%= user %></u></strong></p></div>
</div>

<div style="padding-top:10px; padding-bottom:10px; padding-left:30px; padding-right:30px;" >
  <div class="container-fluid" id="chat-board">
    <div id="messages" class="overflow-auto msgs" style="overflow-y: scroll;">
    </div>
    <form id="msgForm" action="" method="POST" style="bottom:0; margin: 0% 0% 0% 0%;">
      <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Message" aria-label="Message" id="msg">
        <div class="input-group-append">
          <button class="btn btn-success" type="submit" id="sendBtn">Send</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script type="text/javascript" src="index.js"></script>
<script type="text/javascript">
  window.onload = async () => {
    const msgs = await loadAllMsgs();
    for (let i = 0; i < msgs.length; i+= 1) {
      let scroll = false;
      if (i === msgs.length - 1) {
        scroll = true;
      }
      await addMsg(msgs[i], scroll);
    }
  };

  $(document).ready(() => {
    $(window).resize(() => {
      const bodyheight = window.innerHeight - 222;
      $("#messages").height(bodyheight);
    }).resize();
  });

  const socket = new WebSocket(`ws://${window.location.hostname}:${window.location.port}`);
  socket.addEventListener("open", () => {
    console.log("Connected to WS server");

    $("#msgForm").on("submit", async (e) => {
      e.preventDefault();

      const msgInput = document.getElementById("msg");
      const userInput = msgInput.value;
      if (userInput !== "") {
        const userName = await loadName();

        msgInput.value = "";

        socket.send(JSON.stringify({ name: userName, message: userInput }));
      }
    });
  });

  socket.addEventListener("message", (event) => {
    const data = JSON.parse(event.data);
    addMsg(data, true);
  });
</script>

<%- include("foot"); %>
